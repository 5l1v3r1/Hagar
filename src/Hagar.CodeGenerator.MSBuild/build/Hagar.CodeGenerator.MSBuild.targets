<Project TreatAsLocalProperty="CodeGenDirectory;TargetIsCore;TaskAssembly;OutputFileName;CoreAssembly;FullAssembly;GeneratorAssembly">

  <PropertyGroup>
    <CoreAssembly Condition="'$(HagarCodeGenCoreAssembly)' != ''">$(HagarCodeGenCoreAssembly)</CoreAssembly>
    <CoreAssembly Condition="'$(CoreAssembly)' == ''">$(MSBuildThisFileDirectory)..\tasks\netstandard2.0\Hagar.CodeGenerator.MSBuild.dll</CoreAssembly>

    <!-- Specify the assembly containing the MSBuild tasks. -->
    <TaskAssembly>$(CoreAssembly)</TaskAssembly>
  </PropertyGroup>

  <PropertyGroup>
    <HagarCodeGenLogLevel Condition="'$(HagarCodeGenLogLevel)' == ''">Warning</HagarCodeGenLogLevel>
    <CodeGenDirectory Condition="'$([System.IO.Path]::IsPathRooted($(IntermediateOutputPath)))' == 'true'">$(IntermediateOutputPath)</CodeGenDirectory>
    <CodeGenDirectory Condition="'$(CodeGenDirectory)' == ''">$(ProjectDir)$(IntermediateOutputPath)</CodeGenDirectory>
    <OutputFileName>$(CodeGenDirectory)$(TargetName).hagar.g.cs</OutputFileName>
    <CodeGeneratorEnabled Condition=" '$(DesignTimeBuild)' != 'true'">true</CodeGeneratorEnabled>
  </PropertyGroup>

<!--
  <UsingTask TaskName="Hagar.CodeGenerator.MSBuild.GetDotNetHost" AssemblyFile="$(TaskAssembly)" Condition="'$(CodeGeneratorEnabled)' == 'true' and '$(DotNetHost)' == '' and '$(MSBuildIsCore)' == 'true'" />
-->
  <UsingTask TaskName="Hagar.CodeGenerator.MSBuild.GenerateHagarCode" AssemblyFile="$(TaskAssembly)" Condition="'$(CodeGeneratorEnabled)' == 'true'" />

  <Target Name="GenerateCode"
          BeforeTargets="AssignTargetPaths"
          Condition="'$(CodeGeneratorEnabled)' == 'true'"
          Inputs="@(Compile);@(Reference)"
          Outputs="$(OutputFileName)">
    <Hagar.CodeGenerator.MSBuild.GenerateHagarCode
      ProjectPath="$(MSBuildProjectFullPath)"
      ProjectGuid="$(ProjectGuid)"
      OutputType="$(OutputType)"
      TargetPath="$(TargetPath)"
      Compile="@(Compile -> '%(FullPath)')"
      Reference="@(ReferencePath -> '%(FullPath)')"
      >
    </Hagar.CodeGenerator.MSBuild.GenerateHagarCode>
    <!--
    <ItemGroup>
      <Compile Include="$(OutputFileName)"/>
      <FileWrites Include="$(OutputFileName)"/>
    </ItemGroup>
    -->
  </Target>

  <Target Name="IncludeCodegenOutputDuringDesignTimeBuild"
          BeforeTargets="AssignTargetPaths"
          Condition="'$(CodeGeneratorEnabled)' != 'true' and Exists('$(OutputFileName)')">
    <ItemGroup>
      <Compile Include="$(OutputFileName)"/>
      <FileWrites Include="$(OutputFileName)"/>
    </ItemGroup>
  </Target>
</Project>